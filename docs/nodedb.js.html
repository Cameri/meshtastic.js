<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>nodedb.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Client.html">Client</a><ul class='methods'><li data-type='method'><a href="Client.html#addConnection">addConnection</a></li><li data-type='method'><a href="Client.html#addConnection">addConnection</a></li><li data-type='method'><a href="Client.html#createBLEConnection">createBLEConnection</a></li><li data-type='method'><a href="Client.html#createHTTPConnection">createHTTPConnection</a></li></ul></li><li><a href="IBLEConnection.html">IBLEConnection</a><ul class='methods'><li data-type='method'><a href="IBLEConnection.html#configure">configure</a></li><li data-type='method'><a href="IBLEConnection.html#connect">connect</a></li><li data-type='method'><a href="IBLEConnection.html#disconnect">disconnect</a></li><li data-type='method'><a href="IBLEConnection.html#isDeviceReady">isDeviceReady</a></li><li data-type='method'><a href="IBLEConnection.html#sendData">sendData</a></li><li data-type='method'><a href="IBLEConnection.html#sendPacket">sendPacket</a></li><li data-type='method'><a href="IBLEConnection.html#sendPosition">sendPosition</a></li><li data-type='method'><a href="IBLEConnection.html#sendText">sendText</a></li><li data-type='method'><a href="IBLEConnection.html#setOwner">setOwner</a></li><li data-type='method'><a href="IBLEConnection.html#setRadioConfig">setRadioConfig</a></li></ul></li><li><a href="IHTTPConnection.html">IHTTPConnection</a><ul class='methods'><li data-type='method'><a href="IHTTPConnection.html#configure">configure</a></li><li data-type='method'><a href="IHTTPConnection.html#connect">connect</a></li><li data-type='method'><a href="IHTTPConnection.html#disconnect">disconnect</a></li><li data-type='method'><a href="IHTTPConnection.html#isDeviceReady">isDeviceReady</a></li><li data-type='method'><a href="IHTTPConnection.html#sendData">sendData</a></li><li data-type='method'><a href="IHTTPConnection.html#sendPacket">sendPacket</a></li><li data-type='method'><a href="IHTTPConnection.html#sendPosition">sendPosition</a></li><li data-type='method'><a href="IHTTPConnection.html#sendText">sendText</a></li><li data-type='method'><a href="IHTTPConnection.html#setOwner">setOwner</a></li><li data-type='method'><a href="IHTTPConnection.html#setRadioConfig">setRadioConfig</a></li></ul></li><li><a href="IMeshDevice.html">IMeshDevice</a><ul class='methods'><li data-type='method'><a href="IMeshDevice.html#configure">configure</a></li><li data-type='method'><a href="IMeshDevice.html#isDeviceReady">isDeviceReady</a></li><li data-type='method'><a href="IMeshDevice.html#sendData">sendData</a></li><li data-type='method'><a href="IMeshDevice.html#sendPacket">sendPacket</a></li><li data-type='method'><a href="IMeshDevice.html#sendPosition">sendPosition</a></li><li data-type='method'><a href="IMeshDevice.html#sendText">sendText</a></li><li data-type='method'><a href="IMeshDevice.html#setOwner">setOwner</a></li><li data-type='method'><a href="IMeshDevice.html#setRadioConfig">setRadioConfig</a></li></ul></li><li><a href="NodeDB.html">NodeDB</a><ul class='methods'><li data-type='method'><a href="NodeDB.html#addNode">addNode</a></li><li data-type='method'><a href="NodeDB.html#addPositionData">addPositionData</a></li><li data-type='method'><a href="NodeDB.html#addUserData">addUserData</a></li><li data-type='method'><a href="NodeDB.html#getNodeByNum">getNodeByNum</a></li><li data-type='method'><a href="NodeDB.html#getNodeList">getNodeList</a></li><li data-type='method'><a href="NodeDB.html#nodeNumToUserId">nodeNumToUserId</a></li><li data-type='method'><a href="NodeDB.html#removeNode">removeNode</a></li><li data-type='method'><a href="NodeDB.html#userIdToNodeNum">userIdToNodeNum</a></li></ul></li><li><a href="SettingsManager.html">SettingsManager</a><ul class='methods'><li data-type='method'><a href="SettingsManager.html#.setDebugMode">setDebugMode</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#version">version</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">nodedb.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as constants from "./constants.js"
import { SettingsManager } from "./settingsmanager.js"
import { ProtobufHandler } from "./protobufs/protobufhandler.js"
import EventTarget from '@ungap/event-target' // EventTarget polyfill for Edge and Safari

/**
 * Stores and manages Node objects 
 */
export class NodeDB extends EventTarget {
    
    /******************
    var nodes;
    *******************/

    constructor() {

        super();

        /** @type {Map} */
        this.nodes = new Map();

    }

    /**
     * Adds a node object to the database.
     * @param {NodeInfo} nodeInfo 
     * @returns {number} number of node added
     */
    addNode(nodeInfo) {

        this.nodes.set(nodeInfo.num, nodeInfo);
        this._dispatchInterfaceEvent('nodeListChanged', nodeInfo.num);
        return nodeInfo.num;

    }

    /**
     * Adds user data to an existing node. Creates the node if it doesn't exist.
     * @param {NodeInfo} nodeInfo 
     * @returns {number} number of node modified
     */
    addUserData(nodeNumber, user) {

        let node = this.nodes.get(nodeNumber);

        if (node === undefined) {

            let nodeInfo = {
                num: nodeNumber,
                position: {},
                user: user
            }

            try {
                this.nodes.set(nodeNumber, ProtobufHandler.toProtobuf('NodeInfo', nodeInfo).obj);
            } catch (e) {
                throw new Error('Error in meshtasticjs.nodeDB.addUserData:' + e.message);
            }
            
            this._dispatchInterfaceEvent('nodeListChanged');

            
            return nodeNumber;
        }

        node.user = user;
        this._dispatchInterfaceEvent('nodeListChanged');

        return nodeNumber;
    }

    /**
     * Adds position data to an existing node. Creates the node if it doesn't exist.
     * @param {NodeInfo} nodeInfo 
     * @returns {number} number of node modified
     */
    addPositionData(nodeNumber, position) {

        let node = this.nodes.get(nodeNumber);
        
        if (node === undefined) {

            let nodeInfo = {
                num: nodeNumber,
                position: position,
                user: {}
            }

            try {
                this.nodes.set(nodeNumber, ProtobufHandler.toProtobuf('NodeInfo', nodeInfo).obj);
            } catch (e) {
                throw new Error('Error in meshtasticjs.nodeDB.addPositionData:' + e.message);
            }

            this._dispatchInterfaceEvent('nodeListChanged', nodeNumber);

            return nodeNumber;
        }

        
        node.position = position;
        this._dispatchInterfaceEvent('nodeListChanged', nodeNumber);

        return nodeNumber;
    }

    /**
     * Removes node from the database.
     * @param {number} nodeNumber 
     * @returns {number} number of node removed
     */
    removeNode(nodeNumber) {

        this.nodes.delete(nodeNumber);
        this._dispatchInterfaceEvent('nodeListChanged', nodeNumber);
        return nodeNumber;

    }

    /**
     * Gets a node by its node number
     * @param {number} nodeNumber 
     * @returns {NodeInfo} 
     */
    getNodeByNum(nodeNumber) {

        if (this.nodes.get(nodeNumber) === undefined) {
            return undefined;
        }
        
        return this.nodes.get(nodeNumber);

    }


    // ToDo: Add sort by field option
    /**
     * Gets a list of all nodes in the database.
     * @returns {Map} Map with node numbers as keys and NodeInfo objects as value
     */
    getNodeList() {

        return this.nodes;
    }

    /**
     * Gets the associated user id to a node number, if known
     * @param {number} nodeNumber 
     * @returns {string} user id
     */
    nodeNumToUserId(nodeNumber) {

        let node = this.nodes.get(nodeNumber);

        if (node === undefined || node.user.id === undefined) {
            return undefined;
        }

        return node.user.id;

    }

    /**
     * Gets the node number to a user id, if known
     * @param {string} userId 
     * @returns {number} nodeNumber
     */
    userIdToNodeNum(userId) {

        var nodeNumber = undefined;

        this.nodes.forEach((node, num, map) => {
            if (node.hasOwnProperty('user') === true) {
                if (node.user.id === userId) {
                    nodeNumber = node.num;
                }
            }
        });

        return nodeNumber;
        
    }


    _dispatchInterfaceEvent(eventType, payload) {
        this.dispatchEvent(
            new CustomEvent(eventType, { detail: payload })
        );
    }

}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Thu Oct 22 2020 21:43:44 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
